variables:
  SONAR_PROJECT: "minecraft-rcon"
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  VERSION_SLUG: ${CI_COMMIT_BRANCH}.${CI_COMMIT_SHORT_SHA}

default:
  tags:
    - docker

stages:
  - scan
  - test
  - quality
  - build
  - deploy
  - audit

# Secrets leak prevention
scan-gitguardian:
  image: gitguardian/ggshield:v1.35.0
  stage: scan
  script: ggshield secret scan ci --ignore-known-secrets
  allow_failure: true

# Dependency scanning
scan-fossa:
  image: rust:1.84.0
  stage: scan
  script: 
    - apt-get update && apt-get install -y curl git bash
    - "curl -H 'Cache-Control: no-cache' https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh | bash"
    - export FOSSA_API_KEY=$FOSSA_API_KEY
    - fossa analyze --branch $CI_COMMIT_BRANCH
  rules:
    - if: $CI_COMMIT_BRANCH
  allow_failure: true

# Backend linting
scan-rust:
  image: rust:1.84.0
  stage: scan
  cache:
    key: cargo-$CI_COMMIT_REF_SLUG
    paths:    
      - .cargo
  before_script:
    - cargo --version
    - rustup component add clippy
  script:
    - cargo clippy --message-format=json | tee clippy.json
  artifacts:
    name: scan-rust
    paths:
      - clippy.json

# Frontend testing
test-angular:
  image: node:lts
  stage: test
  dependencies: []
  cache: 
    key: npm-$CI_COMMIT_REF_SLUG
    paths:
      - .npm
  before_script:
    - npm -v
    - node -v
    - apt-get update
    - apt-get install -yq gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget
    - npm config set "//npm.fontawesome.com/:_authToken" $FONTAWESOME_PACKAGE_TOKEN
    - npm ci --cache .npm --prefer-offline --no-audit --prefix ./ui
  script:
    - cd ui
    - ./node_modules/.bin/ng test --no-watch --no-progress --code-coverage --browsers=ChromeHeadlessNoSandbox
  coverage: '/Statements\s+:\s\d+.\d+%/'
  artifacts:
    name: reports-angular
    paths:
      - ui/coverage/**/lcov.info/lcov.info
      - ui/coverage/**/cobertura-coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: ui/coverage/**/cobertura-coverage.xml

# Backend testing
test-rust:
  image: rust:1.84.0
  stage: test
  dependencies: []
  cache:
    key: cargo-$CI_COMMIT_REF_SLUG
    paths:    
      - .cargo
  before_script:
    - cargo --version
    - cargo install cargo-tarpaulin -f
  script:
    - cargo tarpaulin --timeout 120 --out xml
  coverage: '/^\d+.\d+% coverage/'
  artifacts:
    name: reports-rust
    paths:
      - cobertura.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: cobertura.xml

# Quality reports
quality-sonarqube:
  image:
    name: sonarsource/sonar-scanner-cli:11
    entrypoint: [""]
  stage: quality
  needs:
    - job: scan-rust
      artifacts: true
    - job: test-angular
      artifacts: true
    - job: test-rust
      artifacts: true
  cache:
    key: sonar-$CI_JOB_NAME
    paths:
      - .sonar/cache
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true
  script:
    - sonar-scanner -X -Dsonar.projectKey=${SONAR_PROJECT} -Dsonar.projectVersion=${CI_COMMIT_BRANCH}.${CI_COMMIT_SHORT_SHA}

# Frontend build
build-angular:
  image: node:lts
  stage: build
  dependencies: []
  cache: 
    key: npm-$CI_COMMIT_REF_SLUG
    paths:
      - .npm
  before_script:
    - npm -v
    - node -v
    - npm config set "//npm.fontawesome.com/:_authToken" $FONTAWESOME_PACKAGE_TOKEN
    - npm ci --cache .npm --prefer-offline --no-audit --prefix ./ui
  script:
    - cd ui
    - sed -i -e "s|%VERSION_SLUG%|${VERSION_SLUG}|g" src/environments/environment.prod.ts
    - ./node_modules/.bin/ng build --configuration production
  artifacts:
    name: www
    paths:
      - ui/dist/*

# Backend build
build-rust:
  image: rust:1.84.0
  stage: build
  dependencies: []
  cache:
    key: cargo-$CI_COMMIT_REF_SLUG
    paths:   
      - .cargo
  before_script:
    - cargo --version
  script:
    - cargo build --release --verbose
  artifacts:
    name: api
    paths:
      - target/release/minecraft-rcon

# Backend per-feature builds validation
build-rust-features:
  image: rust:1.84.0
  stage: build
  dependencies: []
  cache:
    key: cargo-$CI_COMMIT_REF_SLUG
    paths:   
      - .cargo
  parallel:
    matrix:
      - FEATURE: 
        - metrics
        - swagger
  before_script:
    - cargo --version
  script:
    - cargo build --no-default-features --features $FEATURE --release --verbose

# Docker image build and push
deploy-kaniko:
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  stage: deploy
  needs:
    - job: build-angular
      artifacts: true
    - job: build-rust
      artifacts: true
  before_script: 
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(echo -n ${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD} | base64)\"}}}" > /kaniko/.docker/config.json
  script:
    - >-
      /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --build-arg VERSION_SLUG=${VERSION_SLUG}
      --destination "${FULL_IMAGE_NAME}"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        FULL_IMAGE_NAME: "${CI_REGISTRY_IMAGE}:latest"
    - if: $CI_COMMIT_BRANCH
      variables:
        FULL_IMAGE_NAME: "${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_SLUG}"
    - if: $CI_COMMIT_TAG
      variables:
        FULL_IMAGE_NAME: "${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_SLUG}"

# Portainer deployment
deploy-portainer:
  image:
    name: alpine/curl:8.10.0
  stage: deploy
  needs:
    - job: deploy-kaniko
  script:
    - curl -sSfk -X POST "${PORTAINER_WEBHOOK}" 
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# Docker image audit
audit-trivy:
  image:
    name: docker.io/aquasec/trivy:0.58.1
    entrypoint: [""]
  stage: audit
  dependencies: []
  cache:
    key: trivycache
    paths:
      - .trivycache/
  allow_failure: true
  variables:
    # No need to clone the repo, we exclusively work on artifacts.
    # See https://docs.gitlab.com/ee/ci/runners/README.html#git-strategy
    GIT_STRATEGY: none
    TRIVY_USERNAME: "${CI_REGISTRY_USER}"
    TRIVY_PASSWORD: "${CI_REGISTRY_PASSWORD}"
    TRIVY_AUTH_URL: "${CI_REGISTRY}"
    TRIVY_NO_PROGRESS: "true"
    TRIVY_SCANNERS: "vuln"
    TRIVY_CACHE_DIR: ".trivycache/"
  script:
    - trivy --version
    # Cache cleanup is needed when scanning images with the same tags, it does not remove the database
    - time trivy clean --scan-cache
    # Update vulnerabilities database
    - time trivy image --download-db-only
    # Builds report and puts it in the default workdir $CI_PROJECT_DIR, so `artifacts:` can take it from there
    - time trivy image --exit-code 0 --format template --template "@/contrib/gitlab.tpl" --output "${CI_PROJECT_DIR}/gl-container-scanning-report.json" "${FULL_IMAGE_NAME}"
    # Prints full report
    - time trivy image --exit-code 0 "${FULL_IMAGE_NAME}"
    # Fail on critical vulnerabilities
    - time trivy image --exit-code 1 --severity CRITICAL --ignore-unfixed "${FULL_IMAGE_NAME}"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        FULL_IMAGE_NAME: "${CI_REGISTRY_IMAGE}:latest"
    - if: $CI_COMMIT_BRANCH
      variables:
        FULL_IMAGE_NAME: "${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_SLUG}"
    - if: $CI_COMMIT_TAG
      variables:
        FULL_IMAGE_NAME: "${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_SLUG}"
  artifacts:
    when: always
    reports:
      container_scanning: gl-container-scanning-report.json