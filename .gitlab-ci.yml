variables:
  VERSION_SLUG: ${CI_COMMIT_BRANCH}.${CI_COMMIT_SHORT_SHA}

default:
  tags:
    - docker
    - linux/amd64

stages:
  - env
  - scan
  - test
  - quality
  - build
  - publish
  - deploy
  - audit

include:
  # Scanners
  - component: gitlab.kirauks.net/dev-ops/components/scanners/gitguardian@3.2.2
    inputs:
      job_name: gitguardian
      stage: scan
      allow_failure: true

  - component: gitlab.kirauks.net/dev-ops/components/scanners/syft@3.2.2
    inputs:
      job_name: syft
      stage: scan
      allow_failure: true

  - component: gitlab.kirauks.net/dev-ops/components/scanners/sonarqube@3.2.2
    inputs:
      job_name: sonarqube
      stage: quality
      allow_failure: true

  - component: gitlab.kirauks.net/dev-ops/components/scanners/grype@3.2.2
    inputs:
      job_name: grype
      stage: quality
      fail_on_severity: critical

  - component: gitlab.kirauks.net/dev-ops/components/rust/clippy@4.0.1
    inputs:
      job_name: rust-clippy
      stage: scan

  # Tests
  - component: gitlab.kirauks.net/dev-ops/components/angular/test@3.0.1
    inputs:
      job_name: angular-test
      stage: test
      context: ./ui

  - component: gitlab.kirauks.net/dev-ops/components/rust/test@4.0.1
    inputs:
      job_name: rust-test
      stage: test
  - component: gitlab.kirauks.net/dev-ops/components/rust/test@4.0.1
    inputs:
      job_name: rust-test-features
      stage: test
      no_default_features: true
      features: $FEATURES

  # Builds
  - component: gitlab.kirauks.net/dev-ops/components/angular/build@3.0.1
    inputs:
      job_name: angular-build
      stage: build
      context: ./ui
      artifacts:
        - ./ui/dist/*

  - component: gitlab.kirauks.net/dev-ops/components/rust/build@4.0.1
    inputs:
      job_name: rust-build:amd64
      stage: build
      target: x86_64-unknown-linux-gnu
      artifacts:
        - ./target/x86_64-unknown-linux-gnu/release/minecraft-rcon
  - component: gitlab.kirauks.net/dev-ops/components/rust/build@4.0.1
    inputs:
      job_name: rust-build-features:amd64
      stage: build
      target: x86_64-unknown-linux-gnu
      no_default_features: true
      features: $FEATURES
      artifacts:
        - ./target/x86_64-unknown-linux-gnu/release/minecraft-rcon

  - component: gitlab.kirauks.net/dev-ops/components/rust/build@4.0.1
    inputs:
      job_name: rust-build:arm64
      stage: build
      target: aarch64-unknown-linux-gnu
      artifacts:
        - ./target/aarch64-unknown-linux-gnu/release/minecraft-rcon
  - component: gitlab.kirauks.net/dev-ops/components/rust/build@4.0.1
    inputs:
      job_name: rust-build-features:arm64
      stage: build
      target: aarch64-unknown-linux-gnu
      no_default_features: true
      features: $FEATURES
      artifacts:
        - ./target/aarch64-unknown-linux-gnu/release/minecraft-rcon

  # Containers
  - component: gitlab.kirauks.net/dev-ops/components/containers/kaniko@2.1.1
    inputs:
      job_name: kaniko:amd64
      stage: publish
      dockerfile: Dockerfile.amd64
      platform: linux/amd64
      base_tag: ${IMAGE_TAG}

  - component: gitlab.kirauks.net/dev-ops/components/containers/kaniko@2.1.1
    inputs:
      job_name: kaniko:arm64
      stage: publish
      dockerfile: Dockerfile.arm64
      platform: linux/arm64
      base_tag: ${IMAGE_TAG}

  - component: gitlab.kirauks.net/dev-ops/components/containers/manifest@2.1.1
    inputs:
      job_name: manifest
      stage: publish
      platforms: linux/amd64,linux/arm64
      base_tag: ${IMAGE_TAG}

  - component: gitlab.kirauks.net/dev-ops/components/containers/trivy@2.1.1
    inputs:
      job_name: trivy
      stage: audit
      image_tag: ${IMAGE_TAG}
      allow_failure: true

  - component: gitlab.kirauks.net/dev-ops/components/containers/portainer@2.1.1
    inputs:
      job_name: portainer
      stage: deploy
      portainer_webhook: ${PORTAINER_WEBHOOK}
      allow_failure: true

env:
  image: busybox:1.37.0
  stage: env
  script:
    - echo "IMAGE_TAG=${IMAGE_TAG}" > build.env
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        IMAGE_TAG: "latest"
    - if: $CI_COMMIT_BRANCH
      variables:
        IMAGE_TAG: "${CI_COMMIT_REF_SLUG}"
    - if: $CI_COMMIT_TAG
      variables:
        IMAGE_TAG: "${CI_COMMIT_REF_SLUG}"
  artifacts:
    reports:
      dotenv: build.env

sonarqube:
  needs:
    - job: rust-clippy
      artifacts: true
    - job: angular-test
      artifacts: true
    - job: rust-test
      artifacts: true
  
grype:
  needs:
    - job: syft
      artifacts: true

angular-test:
  before_script:
    - npm -v
    - node -v
    - npm config set "//npm.fontawesome.com/:_authToken" $FONTAWESOME_PACKAGE_TOKEN

angular-build:
  before_script:
    - npm -v
    - node -v
    - npm config set "//npm.fontawesome.com/:_authToken" $FONTAWESOME_PACKAGE_TOKEN
    - sed -i -e "s|%VERSION_SLUG%|${VERSION_SLUG}|g" ui/src/environments/environment.prod.ts 

rust-test:
  tags:
    - docker
    - linux/amd64
    - privileged
    - vlan/dmz # Minecraft server
    
rust-test-features:
  tags:
    - docker
    - linux/amd64
    - privileged
    - vlan/dmz # Minecraft server
  parallel:
    matrix:
      - FEATURES: 
        - metrics
        - swagger

rust-build-features:amd64:
  parallel:
    matrix:
      - FEATURES: 
        - metrics
        - swagger

rust-build-features:arm64:
  parallel:
    matrix:
      - FEATURES: 
        - metrics
        - swagger

kaniko:amd64:
  dependencies: 
    - env
    - angular-build
    - rust-build:amd64

kaniko:arm64:
  dependencies: 
    - env
    - angular-build
    - rust-build:arm64

manifest:
  needs:
    - job: env
      artifacts: true
    - job: kaniko:amd64
      artifacts: false
    - job: kaniko:arm64
      artifacts: false
    